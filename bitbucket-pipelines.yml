image: openjdk:19
clone:
  depth: full
pipelines:
  default:
    - step:
        name: build Java components
        caches:
          - gradle
          - gradlewrapper
          - node
        script:
            - microdnf install nodejs npm
            - ./gradlew build
            - ./gradlew net.tangly.erp.ui:installDist -Pvaadin.productionMode
        artifacts:
            - net.tangly.erp.ui/build/distributions/**
            - net.tangly.erp.ui/build/install/**
    - step:
          name: deploy artifacts to Bitbucket downloads section
          script:
              - export ERP_VER=$(awk -F "=" '/project.version/ {gsub(/ |"/,"", $2);print $2}' net.tangly.erp.ui/build.gradle)
              - >-
                curl -X POST --user "${BB_AUTH_STRING}" "https://api.bitbucket.org/2.0/repositories//tangly-team/tangly-os/downloads"
                --form files=@"net.tangly.erp.ui/build/distributions/net.tangly.erp.ui-${ERP_VER}.zip"
  custom:
      docker-hub-deployment:
        - step:
            script:
              - docker build -t tanglyllc/tangly-erp:latest net.tangly.erp.ui/
              - docker login -u $DOCKER_HUB_USER -p $DOCKER_HUB_PASSWORD
              - docker push tanglyllc/tangly-erp:latest
            services:
              - docker
      heroku-docker-deployment:
        - step:
            script:
                - docker build -t tanglyllc/tangly-erp:latest net.tangly.erp.ui/
                - curl https://cli-assets.heroku.com/install-ubuntu.sh | sh
                - heroku container:login
                - heroku container:push web -a $HEROKU_DOCKER_APP_NAME
                - heroku container:release web -a $HEROKU_DOCKER_APP_NAME
            services:
                - docker
      heroku-java-app-deployment:
        - step:
            script:
                - curl https://cli-assets.heroku.com/install-ubuntu.sh | sh
                - heroku plugins:install java
                - heroku deploy:jar net.tangly.erp.ui/build/install/xx.jar --app $HEROKU_JAVA_APP_NAME
definitions:
  caches:
    gradlewrapper: ~/.gradle/wrapper
